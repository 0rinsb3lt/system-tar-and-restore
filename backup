#!/bin/bash

clear

while getopts "d:" arg; do
  case $arg in
    d) 
      FOLDER=$OPTARG
    ;;
    \?) 
      echo "Usage: $0 -d [path for backup folder]"
      exit
    ;;
  esac
done

if [ $(id -u) -gt 0 ]; then
  echo "Please run the script as root. Exit"
  exit
fi

if [ ! -d "/boot/grub/" ]; then
  echo "Cannot find grub, aborting."
  exit
fi

if [ -z "$FOLDER" ]; then

echo "This script will make a full tar backup image of your entire system"
echo "Make sure you have enough free space"
echo "Press ENTER and select the location where the backup file will be created" 
read -s a

echo -e "\nThe default folder for creating the backup file is / (root)" 
fi

def="y"

while [ -z "$FOLDER" ]; do

  read -p "Do you want to save in the default folder? (Y/n): " an

  if [ -n "$an" ]; then
    def=$an
  fi
  
  if [ $def = "y" ] || [ $def = "Y" ]; then
    FOLDER="/"
  elif [ $def = "n" ] || [ $def = "N" ]; then
    read -p "Insert the folder path where the backup will be created: " FOLDER
  else
    echo -e "Please enter a valid option\n"
  fi
done  


FOLDER=(`echo ${FOLDER}/$(date +%A-%d-%m-%Y) | sed 's://*:/:g'`)

echo "Preparing"
mkdir -p $FOLDER
touch $FOLDER/log
touch $FOLDER/errors

sleep 1
echo "Creating backup image, please wait"

rotdash2(){
  p=$1
  while [ -d /proc/$p ]; do
    echo -en . ; sleep 5
    echo -en . ; sleep 5
    echo -en . ; sleep 5
    echo -en . ; sleep 5
    echo -en . ; tput sgr0 ; sleep .2
  done
  }

tar cvpzf  $FOLDER/Backup-"`date +%A-%d-%m-%Y-%T`".tgz  --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/* --exclude=/boot/grub/* --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude=$FOLDER / 2>>$FOLDER/errors | tee $FOLDER/log 

#rotdash2 $!

echo "Setting permissions"
chmod ugo+rw -R "${FOLDER[@]}" 2>> $FOLDER/errors

echo "Done. Tar image and logs saved in $FOLDER"
