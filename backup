#!/bin/bash

clear

BRargs=`getopt -o "d:hf" -l "directory:,exclude-home,fedora-tar,help" -n "$1" -- "$@"`

if [ $? -ne 0 ];
then
  echo "See $0 --help"
  exit 
fi

eval set -- "$BRargs";

while true; do
  case "$1" in
    -d|--directory)
      BRFOLDER=$2
      shift 2
    ;;
    -h|--exclude-home) 
      BRhome="n"
      shift
    ;;
    -f|--fedora-tar) 
      BRtar="y"
      shift
    ;;
    --help)
      echo "
-d, --directory		path for backup folder
-h, --exclude-home	exclude home, include only hidden files and folders
-f, --fedora-tar	Activate --acls  --selinux --xattrs

--help	print this page
"
      exit
      shift
    ;;  
    --)
      shift
      break
    ;;
  esac
done

if [ $(id -u) -gt 0 ]; then
  echo "Please run the script as root. Exit"
  exit
fi


if [ -z "$BRFOLDER" ]; then

echo "This script will make a full tar backup image of your entire system."
echo "Make sure you have GRUB or SYSLINUX packages installed.
GRUB Packages:
-->Arch: grub-bios
-->Debian: grub-pc
-->Fedora: grub2
SYSLINUX Packages:
-->Arch: syslinux
-->Debian: syslinux extlinux
-->Fedora: syslinux syslinux-extlinux"
echo "Make sure you have enough free space."
echo "Press ENTER and select the location where the backup file will be created." 
read -s a

echo -e "\nThe default folder for creating the backup file is / (root)" 
fi

if [ -n "$BRFOLDER" ]; then
  if [ ! -d "$BRFOLDER" ] ||  [ -z $BRFOLDER ]; then
    echo "Directory does not exist."
    read -p "Do you want to save in the default folder? (Y/n): " an

    if [ -n "$an" ]; then
      def=$an
    else
      def="y"
    fi

    if [ $def = "y" ] || [ $def = "Y" ]; then
      BRFOLDER="/"
    elif [ $def = "n" ] || [ $def = "N" ]; then
    while [  -z "$BRFOLDER" ] || [ ! -d "$BRFOLDER" ]; do
      read -p "Insert the folder path where the backup will be created: " BRFOLDER
      if [ ! -d "$BRFOLDER" ]; then
        echo "Directory does not exist."
      fi
    done 
    fi
  fi
fi

while [ -z "$BRFOLDER" ]; do
  read -p "Do you want to save in the default folder? (Y/n): " an

  if [ -n "$an" ]; then
    def=$an
  else
    def="y"
  fi
  
  if [ $def = "y" ] || [ $def = "Y" ]; then
    BRFOLDER="/"
  elif [ $def = "n" ] || [ $def = "N" ]; then
    while [  -z "$BRFOLDER" ] || [ ! -d "$BRFOLDER" ]; do
      read -p "Insert the folder path where the backup will be created: " BRFOLDER
      if [ ! -d "$BRFOLDER" ]; then
        echo "Directory does not exist."
      fi
    done 
  fi
done  

while [ -z "$BRhome" ]; do
  
  echo " "
  read -p "Do you want to include home? 
If no, only hidden files and folders will be included (Y/n): " an

  if [ -n "$an" ]; then
    def=$an
  else
    def="y"
  fi
  
  if [ $def = "y" ] || [ $def = "Y" ]; then
    BRhome="y"
  elif [ $def = "n" ] || [ $def = "N" ]; then
    BRhome="n"
  else
    echo -e "Please enter a valid option\n"
  fi
done  

while [ -z "$BRtar" ]; do
  
  echo " "
  read -p "Activate --acls  --selinux --xattrs options? (Required / Available only in Fedora) (y/N): " an

  if [ -n "$an" ]; then
    def=$an
  else
    def="n"
  fi
  
  if [ $def = "y" ] || [ $def = "Y" ]; then
    BRtar="y"
  elif [ $def = "n" ] || [ $def = "N" ]; then
    BRtar="n"
  else
    echo -e "Please enter a valid option\n"
  fi
done  

echo " "

echo "SYMMARY  
Backup Folder = $BRFOLDER
Include Home Directory = $BRhome
Activated Fedora's tar options = $BRtar"

echo " "

if [ -z $defcon ]; then
read -p "Do you want continue? (Y/n): " defcon
fi

if [ "x$defcon" = "xn" ] || [ "x$defcon" = "xN" ]; then
exit
fi

BRFOLDER=(`echo ${BRFOLDER}/$(date +%A-%d-%m-%Y) | sed 's://*:/:g'`)

echo "Preparing"
mkdir -p $BRFOLDER
touch $BRFOLDER/log
touch $BRFOLDER/errors

sleep 1
echo "Creating backup image, please wait"

BRFile=$BRFOLDER/Backup-"`date +%A-%d-%m-%Y-%T`"

if [ $BRhome = "n" ] &&  [ $BRtar = "n" ]; then
  tar cvpf  $BRFile.tar  --sparse --exclude=/home --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/* --exclude=/boot/grub/* --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude=$BRFOLDER / 2>>$BRFOLDER/errors | tee $BRFOLDER/log 
  find /home -maxdepth 1 -print | xargs tar rpvf $BRFile.tar --no-recursion 2>>$BRFOLDER/errors | tee $BRFOLDER/log
  find /home -maxdepth 2 -name ".*" -print | xargs tar rpvf $BRFile.tar 2>>$BRFOLDER/errors | tee $BRFOLDER/log
  gzip $BRFile.tar
elif [ $BRhome = "y" ] &&  [ $BRtar = "n" ]; then
  tar cvpzf  $BRFile.tgz  --sparse --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/* --exclude=/boot/grub/* --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude=$BRFOLDER / 2>>$BRFOLDER/errors | tee $BRFOLDER/log 
elif [ $BRhome = "n" ] &&  [ $BRtar = "y" ]; then
  tar cvpf  $BRFile.tar  --sparse  --acls  --selinux --xattrs --exclude=/home --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/* --exclude=/boot/grub/* --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude=$BRFOLDER / 2>>$BRFOLDER/errors | tee $BRFOLDER/log 
  find /home -maxdepth 1 -print | xargs tar rpvf $BRFile.tar --no-recursion 2>>$BRFOLDER/errors | tee $BRFOLDER/log
  find /home -maxdepth 2 -name ".*" -print | xargs tar rpvf $BRFile.tar 2>>$BRFOLDER/errors | tee $BRFOLDER/log
  gzip $BRFile.tar
elif [ $BRhome = "y" ] &&  [ $BRtar = "y" ]; then
  tar cvpzf  $BRFile.tgz  --sparse --acls  --selinux --xattrs --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/* --exclude=/boot/grub/* --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude=$BRFOLDER / 2>>$BRFOLDER/errors | tee $BRFOLDER/log 
fi

echo "Setting permissions"
chmod ugo+rw -R "${BRFOLDER[@]}" 2>> $BRFOLDER/errors

echo "Done. Tar image and logs saved in $BRFOLDER"
