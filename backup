#!/bin/bash

clear

show_summary() {
echo "Backup Folder = $BRFOLDER
Include Home Directory = $BRhome"

if [ $BRhome = "n" ]; then
  echo "Keep home's hidden files and folders = $BRhidden"
fi

if [ $BRtar = "y" ]; then
  echo "Fefora detected: --acls --selinux --xattrs options activated"
fi
}

run_tar () {
if [ $BRhome = "n" ] &&  [ $BRhidden = "y" ] &&  [ $BRtar = "n" ]; then
  tar cvpf  "$BRFile".tar  --sparse --exclude=/home --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/*  --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude="$BRFOLDER" / 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log 
  echo "==>Locating hidden files and folders inside /home, please wait..." 
  find /home -maxdepth 1 -print | xargs tar rpvf "$BRFile".tar --no-recursion 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log
  find /home -maxdepth 2 -name ".*" -print | xargs tar rpvf "$BRFile".tar 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log
  echo "==>Creating archive..."
  gzip "$BRFile".tar
elif [ $BRhome = "n" ] &&  [ $BRhidden = "n" ] &&  [ $BRtar = "n" ]; then
  tar cvpzf  "$BRFile".tgz  --sparse --exclude=/home/* --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/*  --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude="$BRFOLDER" / 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log 
elif [ $BRhome = "y" ] &&  [ $BRtar = "n" ]; then
  tar cvpzf  "$BRFile".tgz  --sparse --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/*  --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude="$BRFOLDER" / 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log 
elif [ $BRhome = "n" ] &&  [ $BRhidden = "y" ] &&  [ $BRtar = "y" ]; then
  tar cvpf  "$BRFile".tar  --sparse  --acls  --selinux --xattrs --exclude=/home --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/*  --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude="$BRFOLDER" / 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log 
  echo "==>Locating hidden files and folders inside /home, please wait..." 
  find /home -maxdepth 1 -print | xargs tar rpvf "$BRFile".tar --no-recursion 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log
  find /home -maxdepth 2 -name ".*" -print | xargs tar rpvf "$BRFile".tar 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log
   echo "==>Creating archive..."
  gzip "$BRFile".tar
elif [ $BRhome = "n" ] &&  [ $BRhidden = "n" ] &&  [ $BRtar = "y" ]; then
    tar cvpzf  "$BRFile".tgz  --sparse --acls  --selinux --xattrs --exclude=/home/* --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/*  --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude="$BRFOLDER" / 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log 
elif [ $BRhome = "y" ] &&  [ $BRtar = "y" ]; then
  tar cvpzf  "$BRFile".tgz  --sparse --acls  --selinux --xattrs --exclude=/run/*  --exclude=/lost+found --exclude=/dev/* --exclude=/proc/* --exclude=/sys/* --exclude=/media/* --exclude=/tmp/* --exclude=/mnt/* --exclude=.gvfs  --exclude="$BRFOLDER" / 2>>"$BRFOLDER"/errors | tee "$BRFOLDER"/log 
fi
}

BRargs=`getopt -o "i:d:hn" -l "interface:,directory:,exclude-home,no-hidden,help" -n "$1" -- "$@"`

if [ $? -ne 0 ]; then
  echo "See $0 --help"
  exit 
fi

eval set -- "$BRargs";

while true; do
  case "$1" in
    -i|--interface)
      BRinterface=$2
      shift 2
    ;;
    -d|--directory)
      BRFOLDER=$2
      shift 2
    ;;
    -h|--exclude-home) 
      BRhome="n"
      shift
    ;;
    -n|--no-hidden)
      BRhidden="n"
      shift
    ;;
    --help)
      echo "
-i, --interface         interface to use
-d, --directory		path for backup folder
-h, --exclude-home	exclude /home
-n  --no-hidden         dont keep home's hidden files and folders

--help	print this page
"
      exit
      shift
    ;;  
    --)
      shift
      break
    ;;
  esac
done

if [ $(id -u) -gt 0 ]; then
  echo -e "\e[00;31mScript must run as root.\e[00m"
  exit
fi

if [ -f /etc/fedora-release ]; then
  BRtar="y"
else
  BRtar="n"
fi

PS3="Choice: "
interfaces=(CLI Dialog)

while [ -z "$BRinterface" ]; do
  echo -e "\n\e[00;36mSelect interface or enter Q to quit\e[00m"
  select c in ${interfaces[@]}; do
    if [ $REPLY = "q" ] || [ $REPLY = "Q" ]; then
      echo -e "\e[00;33mAborted by User\e[00m"
      exit
    elif [[ $REPLY = [0-9]* ]] && [ $REPLY -gt 0 ] && [ $REPLY -le ${#interfaces[@]} ]; then
      BRinterface=$c
      break
    else
      echo -e "\e[00;31mPlease select a valid option from the list or enter Q to quit\e[00m"
    fi
  done
done

if [ $BRinterface = "CLI" ]; then
  clear
  if [ -z "$BRFOLDER" ]; then
    echo "This script will make a tar backup image of your entire system."
    echo -e "\n==>Make sure you have enough free space."
    echo -e "\n==>Also make sure you have GRUB or SYSLINUX packages installed."
    echo -e "\n\e[00;33mGRUB Packages:\e[00m"
    echo "Arch: grub-bios"
    echo "Debian: grub-pc"
    echo "Fedora: grub2"
    echo -e "\n\e[00;33mSYSLINUX Packages:\e[00m"
    echo "Arch: syslinux"
    echo "Debian: syslinux extlinux"
    echo "Fedora: syslinux syslinux-extlinux"
    echo -e "\n\e[00;36mPress ENTER to continue.\e[00m" 
    read -s a
    clear
  fi

  if [ ! -d "$BRFOLDER" ] && [ -n "$BRFOLDER" ]; then
    echo -e "\e[00;31mDirectory does not exist.\e[00m"
    unset BRFOLDER
  fi

  while [ -z "$BRFOLDER" ]; do
    echo -e "\n\e[00;36mThe default folder for creating the backup file is / (root)\nDo you want to save in the default folder?\e[00m" 
    read -p "(Y/n): " an

    if [ -n "$an" ]; then
      def=$an
    else
      def="y"
    fi
  
    if [ $def = "y" ] || [ $def = "Y" ]; then
      BRFOLDER="/"
    elif [ $def = "n" ] || [ $def = "N" ]; then
      while [  -z "$BRFOLDER" ] || [ ! -d "$BRFOLDER" ]; do
        echo -e "\n\e[00;36mInsert the folder path where the backup will be created\e[00m"
        read -p "Path: " BRFOLDER
        if [ ! -d "$BRFOLDER" ]; then
          echo -e "\e[00;31mDirectory does not exist.\e[00m"
        fi
      done 
    else
      echo -e "\e[00;31mPlease enter a valid option\e[00m"
    fi
  done 

  while [ -z "$BRhome" ] ; do
    echo -e "\n\e[00;36mDo you want to include /home?\e[00m"
    read -p "(Y/n):" an

    if [ -n "$an" ]; then
      def=$an
    else
      def="y"
    fi
  
    if [ $def = "y" ] || [ $def = "Y" ]; then
      BRhome="y"
    elif [ $def = "n" ] || [ $def = "N" ]; then
      BRhome="n"
    else
      echo -e "\e[00;31mPlease enter a valid option\e[00m"
    fi
  done  

  if [ $BRhome = "n" ]; then
    while [ -z "$BRhidden" ] ; do
      echo -e "\n\e[00;36mDo you want to keep hidden files and folders inside /home?\e[00m"
      read -p "(Y/n):" an

      if [ -n "$an" ]; then
        def=$an
      else
        def="y"
      fi

      if [ $def = "y" ] || [ $def = "Y" ]; then
        BRhidden="y"
      elif [ $def = "n" ] || [ $def = "N" ]; then
        BRhidden="n"
      else
        echo -e "\e[00;31mPlease enter a valid option\e[00m"
      fi 
    done
  fi

  echo -e "\n\e[00;32mSUMMARY\e[00m"
  show_summary

  while [ -z "$BRcontinue" ]; do
    echo -e "\n\e[00;36mDo you want continue?\e[00m"
    read -p "(Y/n):" an

    if [ -n "$an" ]; then
      def=$an
    else
      def="y"
    fi
  
    if [ $def = "y" ] || [ $def = "Y" ]; then
      BRcontinue="y"
    elif [ $def = "n" ] || [ $def = "N" ]; then
      BRcontinue="n"
      echo -e "\e[00;33mAborted by User\e[00m"
      exit
    else
      echo -e "\e[00;31mPlease enter a valid option\e[00m"
    fi
  done  

  if [  "x$BRcontinue" = "xy" ]; then
    BRFOLDER_IN=(`echo ${BRFOLDER}/$(date +%A-%d-%m-%Y) | sed 's://*:/:g'`)
    BRFOLDER="${BRFOLDER_IN[@]}"

    echo "==>Preparing..."
    mkdir -p "$BRFOLDER"
    touch "$BRFOLDER"/log
    touch "$BRFOLDER"/errors
    sleep 1

    echo "==>Creating backup image, please wait..."
    BRFile="$BRFOLDER"/Backup-"`date +%A-%d-%m-%Y-%T`"
    sleep 1

    run_tar

    echo "==>Setting permissions"
    chmod ugo+rw -R "$BRFOLDER" 2>> "$BRFOLDER"/errors
    echo "==>Done. Backup image and logs saved in $BRFOLDER"
  fi  

elif [ $BRinterface = "Dialog" ]; then
  if [ -z $(which dialog 2> /dev/null) ];then
    echo -e "\e[00;31mPackage dialog is not installed\n\e[00;36mInstall the package and re-run the script\e[00m"
    exit
  fi

  if [ -z "$BRFOLDER" ]; then
    dialog --no-ok --title "Info" --msgbox  "This script will make a tar backup image of your entire system.

==>Make sure you have enough free space.

==>Make sure you have GRUB or SYSLINUX packages installed.

GRUB Packages:
-->Arch: grub-bios
-->Debian: grub-pc
-->Fedora: grub2

SYSLINUX Packages:
-->Arch: syslinux
-->Debian: syslinux extlinux
-->Fedora: syslinux syslinux-extlinux

Press OK to continue." 20 100
  fi

  if [ ! -d "$BRFOLDER" ] &&  [ -n "$BRFOLDER" ]; then
    echo "Directory does not exist." | dialog --progressbox "ERROR" 30 70
    sleep 2
    unset BRFOLDER
  fi

  while [ -z "$BRFOLDER" ]; do
    dialog --title "Message" --yesno "The default folder for creating the backup file is / (root). Do you want to save in the default folder?" 8 50
    if [ $? = "0" ]; then
      BRFOLDER="/"
    else
      while [  -z "$BRFOLDER" ] || [ ! -d "$BRFOLDER" ]; do
        exec 3>&1 
        BRFOLDER=$(dialog  --no-cancel --inputbox "Insert the folder path where the backup will be created" 8 50 2>&1 1>&3)  
        if [ ! -d "$BRFOLDER" ]; then
          echo "Directory does not exist." | dialog --progressbox "ERROR" 30 70
          sleep 2
        fi
      done 
    fi
  done 

  while [ -z "$BRhome" ]; do
    dialog --title "Message"  --yesno "Do you want to include /home?" 8 50
    if [ $? = "0" ]; then
      BRhome="y"
    else
      BRhome="n"
    fi
  done  

  if [ $BRhome = "n" ]; then
    while [ -z "$BRhidden" ] ; do
      dialog --title "Message"  --yesno "Do you want to keep hidden files and folders inside /home?" 8 50
      if [ $? = "0" ]; then
        BRhidden="y"
      else
        BRhidden="n"
      fi
    done
  fi

  dialog --title "Summary"  --yesno "`show_summary`
------------------------------------
Press Yes to continue or No to abort." 13 50

  if [ $? = "1" ]; then
    exit
  fi

  BRFOLDER_IN=(`echo ${BRFOLDER}/$(date +%A-%d-%m-%Y) | sed 's://*:/:g'`)
  BRFOLDER="${BRFOLDER_IN[@]}"

  mkdir -p "$BRFOLDER"
  touch "$BRFOLDER"/log
  touch "$BRFOLDER"/errors
  sleep 1

  BRFile="$BRFOLDER"/Backup-"`date +%A-%d-%m-%Y-%T`"

  run_tar | dialog --progressbox "Creating backup image..." 30 70

  chmod ugo+rw -R "$BRFOLDER" 2>> "$BRFOLDER"/errors
  dialog --title "Info" --msgbox  "Done. Backup image and logs saved in $BRFOLDER" 8 50
else
  echo -e "\e[00;31mWrong interface name\n\e[00;36mAvailable options: CLI Dialog\e[00m"
fi
